<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal Digital Twin Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #ffffff;
        }

        /* Hero Section - Exact colors from AI fact checker */
        .hero {
            background: linear-gradient(135deg, #1a365d 0%, #2d5a87 50%, #4a90a4 100%);
            color: white;
            padding: 50px 0 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            opacity: 0.3;
        }

        .hero-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            font-weight: 300;
            line-height: 1.2;
        }

        .hero .subtitle {
            font-size: 1.2rem;
            margin-bottom: 0;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Upload Section - Exact colors from AI fact checker */
        .upload-section {
            padding: 20px 0;
            background: #f8fafc;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .section-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .section-header h2 {
            font-size: 2.2rem;
            color: #1a365d;
            margin-bottom: 0.5rem;
            font-weight: 300;
        }

        .section-header p {
            font-size: 1.1rem;
            color: #4a5568;
            max-width: 600px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .upload-form {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #1a365d;
            font-size: 1.1rem;
        }

        .form-group .description {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }

        .form-control {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4a90a4;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 0.75rem;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            width: 100%;
            min-height: 80px;
        }

        .file-upload-area:hover {
            border-color: #4a90a4;
            background: #f1f9ff;
        }

        .file-upload-area.dragover {
            border-color: #2d5a87;
            background: #e6f3ff;
            transform: scale(1.02);
        }

        .upload-text {
            font-size: 0.85rem;
            color: #4a5568;
            margin-bottom: 0.1rem;
        }

        .upload-subtext {
            font-size: 0.75rem;
            color: #64748b;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .uploaded-files {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: #e6f3ff;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid #4a90a4;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-name {
            font-weight: 500;
            color: #1a365d;
        }

        .file-size {
            font-size: 0.8rem;
            color: #64748b;
        }

        .remove-file {
            background: none;
            border: none;
            color: #e53e3e;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
        }

        .submit-btn {
            background: linear-gradient(135deg, #2d5a87, #4a90a4);
            color: white;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 2rem auto 0;
            min-width: 200px;
            font-weight: 600;
            width: 100%;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(45, 90, 135, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn {
            background: linear-gradient(135deg, #2d5a87, #4a90a4);
            color: white;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            font-weight: 600;
            width: 100%;
            margin: 1rem 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(45, 90, 135, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            box-shadow: 0 3px 10px rgba(149, 165, 166, 0.2);
        }

        .btn.secondary:hover {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
        }

        .status-success {
            background: #efe;
            border: 1px solid #cfc;
            color: #363;
        }

        .status-error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }

        .status-loading {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #4a5568;
        }

        .persona-count {
            margin: 20px 0;
            padding: 16px;
            background: #e6f3ff;
            border: 1px solid #4a90a4;
            border-radius: 8px;
            color: #1a365d;
            text-align: center;
            font-weight: 600;
        }

        .poll-results {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .poll-results h3 {
            color: #1a365d;
            margin-bottom: 20px;
            margin-top: 0;
        }

        .poll-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .poll-metric {
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .poll-metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d5a87;
            margin-bottom: 4px;
        }

        .poll-metric-label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .poll-details {
            max-height: 400px;
            overflow-y: auto;
        }

        .poll-response {
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #4a90a4;
        }

        .poll-response-header {
            font-weight: 600;
            color: #1a365d;
            margin-bottom: 8px;
        }

        .poll-response-text {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: #f8fafc;
        }

        .chat-message {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
        }

        .chat-message.user {
            background: linear-gradient(135deg, #2d5a87, #4a90a4);
            color: white;
            margin-left: 20%;
        }

        .chat-message.persona {
            background: white;
            border: 1px solid #e2e8f0;
            margin-right: 20%;
            color: #333;
        }

        .chat-message .sender {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
            opacity: 0.8;
        }

        .persona-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .persona-item {
            padding: 12px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .persona-item:hover {
            border-color: #4a90a4;
            background: #f1f9ff;
        }

        .persona-item.active {
            border-color: #4a90a4;
            background: #e6f3ff;
        }

        .persona-name {
            font-weight: 600;
            color: #1a365d;
        }

        .persona-details {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        .divider {
            height: 1px;
            background: #e2e8f0;
            margin: 30px 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a90a4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .hero .subtitle {
                font-size: 1.1rem;
            }
            
            .upload-form {
                padding: 2rem;
            }
            
            .section-header h2 {
                font-size: 2rem;
            }
            
            .poll-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1>Signal Digital Twin Platform</h1>
            <p class="subtitle">AI-powered persona modeling for legal advertising</p>
        </div>
    </section>

    <!-- Upload Section -->
    <section class="upload-section">
        <div class="container">
            <div class="section-header">
                <h2>Generate & Test</h2>
                <p>Generate digital twins and test messaging before spending campaign dollars.</p>
            </div>

            <div class="main-content">
                <!-- Generate Personas Card -->
                <div class="upload-form">
                    <h2 style="color: #1a365d; margin-bottom: 1rem; font-size: 1.5rem;">Generate Digital Twins</h2>
                    <p class="description">Create AI personas based on your case data, target audience, and social insights.</p>
                    
                    <form id="generateForm">
                        <div class="form-group">
                            <label for="matter">Case Type / Matter</label>
                            <input type="text" id="matter" name="matter" class="form-control" placeholder="e.g., Ultra-processed Foods, Personal Injury, Mass Tort" required>
                        </div>

                        <div class="form-group">
                            <label for="target_description">Target Audience Description</label>
                            <textarea id="target_description" name="target_description" class="form-control" placeholder="Describe your ideal clients..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="keywords">Search Keywords</label>
                            <input type="text" id="keywords" name="keywords" class="form-control" placeholder="diabetes, food companies, legal action" required>
                        </div>

                        <div class="form-group">
                            <label for="persona_count">Number of Personas (1-100)</label>
                            <input type="number" id="persona_count" name="persona_count" class="form-control" min="1" max="100" value="15" required>
                        </div>

                        <div class="form-group">
                            <label for="email">Your Email (for report delivery)</label>
                            <input type="email" id="email" name="email" class="form-control" placeholder="your@email.com" required>
                        </div>

                        <div class="form-group">
                            <label>Upload Data Files (Optional)</label>
                            <p class="description">Upload MRI, TargetSmart, or Client data files</p>
                            <div class="file-upload-area">
                                <div class="upload-text">Click to browse or drag MRI file here</div>
                                <div class="upload-subtext">CSV files only, up to 10MB</div>
                                <input type="file" id="mri_file" name="mri_file" class="file-input" accept=".csv">
                            </div>
                            <div class="uploaded-files" id="mriFiles"></div>

                            <div class="file-upload-area">
                                <div class="upload-text">Click to browse or drag TargetSmart file here</div>
                                <div class="upload-subtext">CSV files only, up to 10MB</div>
                                <input type="file" id="targetsmart_file" name="targetsmart_file" class="file-input" accept=".csv">
                            </div>
                            <div class="uploaded-files" id="targetsmartFiles"></div>

                            <div class="file-upload-area">
                                <div class="upload-text">Click to browse or drag Client data file here</div>
                                <div class="upload-subtext">CSV files only, up to 10MB</div>
                                <input type="file" id="client_file" name="client_file" class="file-input" accept=".csv">
                            </div>
                            <div class="uploaded-files" id="clientFiles"></div>
                        </div>

                        <div class="form-group">
                            <label for="creatives_text">Ad Creatives (Text Format)</label>
                            <textarea id="creatives_text" class="form-control" placeholder="Enter each ad creative on a new line:&#10;&#10;Headline: Get Justice Now&#10;Body: Free consultation for diabetes cases...&#10;Image Description: Professional lawyer in office&#10;&#10;Headline: Hold Them Accountable&#10;Body: Major food companies knew the risks...&#10;Image Description: Family at dinner table" rows="6"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Upload Ad Creative Images (Optional - up to 10)</label>
                            <p class="description">Upload images for your ad creatives</p>
                            <div id="imageUploads">
                                <!-- JavaScript will generate 10 image upload areas -->
                            </div>
                        </div>

                        <button type="submit" class="submit-btn" id="generateBtn">
                            Generate Digital Twins
                        </button>
                    </form>

                    <div id="generateStatus" class="status-message"></div>
                </div>

                <!-- Poll All Personas Card -->
                <div class="upload-form">
                    <h2 style="color: #1a365d; margin-bottom: 1rem; font-size: 1.5rem;">Poll All Personas</h2>
                    <p class="description">Ask a question to ALL personas at once and get percentage breakdowns of responses.</p>

                    <button class="btn" id="loadPersonasBtn">
                        Load Available Personas
                    </button>

                    <div id="personaCount" class="persona-count" style="display: none;"></div>

                    <div id="pollInterface" style="display: none;">
                        <div class="form-group">
                            <label for="pollQuestion">Question for All Personas</label>
                            <textarea id="pollQuestion" class="form-control" placeholder="Example: How likely are you to call a law firm that offers free consultation? Explain your reasoning." rows="3"></textarea>
                        </div>

                        <button class="btn" id="pollAllBtn">
                            Poll All Personas
                        </button>

                        <div id="pollResults" class="poll-results" style="display: none;">
                            <h3>Poll Results</h3>
                            <div id="pollSummary" class="poll-summary"></div>
                            <div id="pollDetails" class="poll-details"></div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <h3 style="color: #1a365d; font-size: 1.2rem; margin-bottom: 1rem;">Individual Chat</h3>
                    <p class="description">Describe the type of persona you want to chat with, and we'll create one for you.</p>

                    <div id="personaCreationInterface">
                        <div class="form-group">
                            <label for="personaAttributes">Describe Your Ideal Persona</label>
                            <textarea id="personaAttributes" class="form-control" placeholder="Example: 45-year-old female from Texas, household income $60k, mother of diabetic teenager, works in healthcare, skeptical of lawyers but concerned about food safety" rows="3"></textarea>
                        </div>

                        <button class="btn" id="createPersonaBtn">
                            Create & Chat with This Persona
                        </button>
                    </div>

                    <div id="chatInterface" style="display: none;">
                        <div id="currentPersonaInfo" class="persona-count" style="margin-bottom: 1rem;">
                            <!-- Current persona info will be displayed here -->
                        </div>

                        <div id="chatContainer" class="chat-container">
                            <div class="chat-message persona">
                                <div class="sender">System</div>
                                Describe a persona above to start chatting!
                            </div>
                        </div>

                        <div class="form-group">
                            <input type="text" id="chatInput" class="form-control" placeholder="Type your message..." disabled>
                        </div>

                        <button class="btn" id="sendChatBtn" disabled>
                            Send Message
                        </button>

                        <button class="btn secondary" id="newPersonaBtn" style="margin-top: 0.5rem;">
                            Create Different Persona
                        </button>
                    </div>

                    <div id="chatStatus" class="status-message"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Configuration - These will now point to your Vercel API endpoints
        window.CONFIG = {
            generateWorkflowUrl: '/api/generate-personas',
            chatEndpointUrl: '/api/chat-persona',
            sheetsUrl: 'https://docs.google.com/spreadsheets/d/1XWQj3hp0yqGdilLMATQPT7CpAj43e6t6eas5JrDZkH4/edit'
        };

        // Global Variables
        let selectedPersona = null;
        let availablePersonas = [];

        // DOM Elements
        const generateForm = document.getElementById('generateForm');
        const generateBtn = document.getElementById('generateBtn');
        const generateStatus = document.getElementById('generateStatus');
        const loadPersonasBtn = document.getElementById('loadPersonasBtn');
        const personaCount = document.getElementById('personaCount');
        const pollInterface = document.getElementById('pollInterface');
        const pollQuestion = document.getElementById('pollQuestion');
        const pollAllBtn = document.getElementById('pollAllBtn');
        const pollResults = document.getElementById('pollResults');
        const pollSummary = document.getElementById('pollSummary');
        const pollDetails = document.getElementById('pollDetails');
        const personaCreationInterface = document.getElementById('personaCreationInterface');
        const personaAttributes = document.getElementById('personaAttributes');
        const createPersonaBtn = document.getElementById('createPersonaBtn');
        const currentPersonaInfo = document.getElementById('currentPersonaInfo');
        const chatInterface = document.getElementById('chatInterface');
        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const newPersonaBtn = document.getElementById('newPersonaBtn');
        const chatStatus = document.getElementById('chatStatus');

        // Utility Functions
        function showStatus(element, message, type) {
            element.className = `status-message status-${type}`;
            element.textContent = message;
            element.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 8000);
            }
        }

        function showLoading(button, originalText) {
            button.disabled = true;
            button.innerHTML = `<span class="loading-spinner"></span>${originalText}`;
        }

        function hideLoading(button, originalText) {
            button.disabled = false;
            button.innerHTML = originalText;
        }

        // Convert text creatives to JSON format
        function parseCreativesText(text) {
            if (!text.trim()) return [];
            
            const creatives = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            let currentCreative = {};
            
            for (const line of lines) {
                if (line.toLowerCase().startsWith('headline:')) {
                    if (currentCreative.headline) {
                        creatives.push(currentCreative);
                        currentCreative = {};
                    }
                    currentCreative.headline = line.substring(9).trim();
                } else if (line.toLowerCase().startsWith('body:')) {
                    currentCreative.body = line.substring(5).trim();
                } else if (line.toLowerCase().startsWith('image description:') || line.toLowerCase().startsWith('image:')) {
                    const prefix = line.toLowerCase().startsWith('image description:') ? 'image description:' : 'image:';
                    currentCreative.image_description = line.substring(prefix.length).trim();
                } else if (line && !line.toLowerCase().includes(':')) {
                    if (currentCreative.body) {
                        currentCreative.body += ' ' + line;
                    } else {
                        currentCreative.body = line;
                    }
                }
            }
            
            if (currentCreative.headline) {
                creatives.push(currentCreative);
            }
            
            return creatives;
        }

        // File upload handling
        function handleFileUpload(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            
            input.addEventListener('change', function(e) {
                display.innerHTML = '';
                const files = Array.from(e.target.files);
                
                if (files.length === 0) return;
                
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                        </div>
                        <button type="button" class="remove-file" onclick="removeFile('${inputId}', ${index})">×</button>
                    `;
                    display.appendChild(fileItem);
                });
            });
        }

        function removeFile(inputId, index) {
            const input = document.getElementById(inputId);
            const dt = new DataTransfer();
            const files = Array.from(input.files);
            
            files.forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });
            
            input.files = dt.files;
            input.dispatchEvent(new Event('change'));
        }

        // Initialize image uploads
        function initializeImageUploads() {
            const imageUploadsContainer = document.getElementById('imageUploads');
            
            for (let i = 0; i < 10; i++) {
                const uploadDiv = document.createElement('div');
                uploadDiv.className = 'file-upload-area';
                uploadDiv.style.marginBottom = '10px';
                uploadDiv.innerHTML = `
                    <div class="upload-text">Click to browse or drag image ${i + 1} here</div>
                    <div class="upload-subtext">JPG, PNG, GIF up to 5MB</div>
                    <input type="file" id="image_${i}" name="image_${i}" class="file-input" accept=".jpg,.jpeg,.png,.gif">
                `;
                imageUploadsContainer.appendChild(uploadDiv);
                
                const filesDiv = document.createElement('div');
                filesDiv.className = 'uploaded-files';
                filesDiv.id = `image${i}Files`;
                imageUploadsContainer.appendChild(filesDiv);
                
                // Set up file handling for this image input
                handleFileUpload(`image_${i}`, `image${i}Files`);
            }
        }

        // Generate Digital Twins Form Handler
        generateForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            
            formData.append('matter', document.getElementById('matter').value);
            formData.append('target_description', document.getElementById('target_description').value);
            formData.append('keywords', document.getElementById('keywords').value);
            formData.append('persona_count', document.getElementById('persona_count').value);
            formData.append('email', document.getElementById('email').value);
            
            const creativesText = document.getElementById('creatives_text').value;
            const creatives = parseCreativesText(creativesText);
            formData.append('creatives', JSON.stringify(creatives));
            
            const dataFiles = ['mri_file', 'targetsmart_file', 'client_file'];
            dataFiles.forEach(fieldName => {
                const fileInput = document.getElementById(fieldName);
                if (fileInput.files.length > 0) {
                    formData.append(fieldName, fileInput.files[0]);
                }
            });
            
            for (let i = 0; i < 10; i++) {
                const imageInput = document.getElementById(`image_${i}`);
                if (imageInput.files.length > 0) {
                    formData.append(`image_${i}`, imageInput.files[0]);
                }
            }
            
            showLoading(generateBtn, 'Generating Digital Twins...');
            showStatus(generateStatus, 'Processing your request... This may take 2-3 minutes. You will receive the report via email.', 'loading');
            
            try {
                const response = await fetch(window.CONFIG.generateWorkflowUrl, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showStatus(generateStatus, 
                        'Digital twins generation started successfully! You will receive the report via email within a few minutes. Check your Google Sheets for persona data.', 
                        'success'
                    );
                    generateForm.reset();
                    initializeImageUploads(); // Reset image uploads
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                showStatus(generateStatus, 
                    `Error generating digital twins: ${error.message}. Please check your network connection and try again.`, 
                    'error'
                );
            } finally {
                hideLoading(generateBtn, 'Generate Digital Twins');
            }
        });

        // Load Personas Handler
        loadPersonasBtn.addEventListener('click', async function() {
            showLoading(loadPersonasBtn, 'Loading Personas...');
            
            try {
                // Mock personas - replace with actual API call
                const mockPersonas = [
                    {
                        name: "Maria Rodriguez",
                        age: 45,
                        demographics: "female, Phoenix AZ",
                        bio: "Single mother working two jobs, concerned about processed food effects on her diabetic teenager",
                        case_type: "Ultra-processed Foods"
                    },
                    {
                        name: "James Mitchell", 
                        age: 52,
                        demographics: "male, Dallas TX",
                        bio: "Construction worker with diabetes, suspicious of food companies and legal promises",
                        case_type: "Ultra-processed Foods"
                    },
                    {
                        name: "Sarah Chen",
                        age: 38,
                        demographics: "female, Seattle WA",
                        bio: "Health-conscious mother researching family's dietary choices and potential legal action",
                        case_type: "Ultra-processed Foods"
                    }
                ];
                
                availablePersonas = mockPersonas;
                personaCount.textContent = `${mockPersonas.length} personas loaded and ready for polling`;
                personaCount.style.display = 'block';
                pollInterface.style.display = 'block';
                
                showStatus(chatStatus, 'Personas loaded successfully! You can now poll all personas or create a custom persona for individual chat.', 'success');
                
            } catch (error) {
                showStatus(chatStatus, `Error loading personas: ${error.message}`, 'error');
            } finally {
                hideLoading(loadPersonasBtn, 'Load Available Personas');
            }
        });

        // Poll All Personas
        pollAllBtn.addEventListener('click', async function() {
            if (!pollQuestion.value.trim()) {
                showStatus(chatStatus, 'Please enter a question to poll all personas.', 'error');
                return;
            }

            showLoading(pollAllBtn, 'Polling All Personas...');
            
            try {
                // Mock polling results - replace with actual API calls
                const results = await simulatePollResults(pollQuestion.value.trim());
                displayPollResults(results);
                
            } catch (error) {
                showStatus(chatStatus, `Error polling personas: ${error.message}`, 'error');
            } finally {
                hideLoading(pollAllBtn, 'Poll All Personas');
            }
        });

        // Simulate poll results (replace with actual API calls)
        async function simulatePollResults(question) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Mock response data
            return {
                question: question,
                responses: [
                    {
                        persona: "Maria Rodriguez",
                        response: "I would be hesitant because I've been burned by lawyers before, but if they could show me they understand my situation with my diabetic son, I might consider it.",
                        sentiment: "cautious"
                    },
                    {
                        persona: "James Mitchell",
                        response: "Free consultation sounds like a trap. Nothing's free. I'd want to know what the catch is before I'd even think about calling.",
                        sentiment: "skeptical"
                    },
                    {
                        persona: "Sarah Chen",
                        response: "I'd research the firm thoroughly first, check reviews, and ask lots of questions during the consultation. The free part is appealing but I need to trust them.",
                        sentiment: "cautious"
                    }
                ],
                summary: {
                    likely: 33,
                    unlikely: 33,
                    neutral: 34,
                    total_responses: 3
                }
            };
        }

        // Create Custom Persona for Chat
        createPersonaBtn.addEventListener('click', async function() {
            if (!personaAttributes.value.trim()) {
                showStatus(chatStatus, 'Please describe the type of persona you want to chat with.', 'error');
                return;
            }

            showLoading(createPersonaBtn, 'Creating Persona...');
            
            try {
                // Generate a custom persona based on user description
                const customPersona = await generateCustomPersona(personaAttributes.value.trim());
                selectedPersona = customPersona;
                
                // Show persona info and enable chat
                currentPersonaInfo.innerHTML = `
                    <strong>Chatting with:</strong> ${customPersona.name}<br>
                    <small>${customPersona.age} years old, ${customPersona.demographics}</small><br>
                    <small>${customPersona.bio}</small>
                `;
                
                chatInterface.style.display = 'block';
                personaCreationInterface.style.display = 'none';
                
                chatInput.disabled = false;
                sendChatBtn.disabled = false;
                chatInput.placeholder = `Ask ${customPersona.name} anything...`;
                
                // Clear chat and show persona intro
                chatContainer.innerHTML = `
                    <div class="chat-message persona">
                        <div class="sender">${customPersona.name}</div>
                        Hi! I'm ${customPersona.name}. ${customPersona.bio} What would you like to know?
                    </div>
                `;
                
                showStatus(chatStatus, `Created ${customPersona.name}! You can now start chatting.`, 'success');
                
            } catch (error) {
                showStatus(chatStatus, `Error creating persona: ${error.message}`, 'error');
            } finally {
                hideLoading(createPersonaBtn, 'Create & Chat with This Persona');
            }
        });

        // Generate Custom Persona (AI-powered)
        async function generateCustomPersona(description) {
            // Simulate AI persona generation - replace with actual API call
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // For now, create a persona based on common patterns in the description
            const persona = {
                name: generatePersonaName(description),
                age: extractAge(description) || Math.floor(Math.random() * 30) + 25,
                demographics: extractLocation(description) || "United States",
                bio: `Based on your description: ${description.substring(0, 100)}...`,
                motivations: ["seeking justice", "protecting family", "getting fair compensation"],
                barriers: ["cost concerns", "trust issues", "time constraints"],
                communication_style: "Direct and practical, asks pointed questions",
                case_type: extractCaseType(description) || "Legal Services"
            };
            
            return persona;
        }

        // Helper functions for persona generation
        function generatePersonaName(description) {
            const femaleNames = ["Maria", "Sarah", "Jennifer", "Lisa", "Nancy", "Karen", "Patricia"];
            const maleNames = ["James", "Michael", "Robert", "David", "John", "Mark", "Steven"];
            
            const isFemale = description.toLowerCase().includes('female') || 
                           description.toLowerCase().includes('mother') || 
                           description.toLowerCase().includes('woman');
            const isMale = description.toLowerCase().includes('male') || 
                         description.toLowerCase().includes('father') || 
                         description.toLowerCase().includes('man');
            
            if (isFemale) {
                return femaleNames[Math.floor(Math.random() * femaleNames.length)];
            } else if (isMale) {
                return maleNames[Math.floor(Math.random() * maleNames.length)];
            } else {
                const allNames = [...femaleNames, ...maleNames];
                return allNames[Math.floor(Math.random() * allNames.length)];
            }
        }

        function extractAge(description) {
            const ageMatch = description.match(/(\d{1,2})[- ]?year[s]?[- ]?old|age[s]?\s+(\d{1,2})|(\d{1,2})[- ]?y[o]?/i);
            if (ageMatch) {
                return parseInt(ageMatch[1] || ageMatch[2] || ageMatch[3]);
            }
            return null;
        }

        function extractLocation(description) {
            const states = ["Texas", "California", "Florida", "New York", "Pennsylvania", "Illinois", "Ohio", "Georgia", "North Carolina", "Michigan"];
            const foundState = states.find(state => description.toLowerCase().includes(state.toLowerCase()));
            
            if (foundState) {
                return `${foundState}, USA`;
            }
            
            if (description.toLowerCase().includes('rural')) return "Rural USA";
            if (description.toLowerCase().includes('urban') || description.toLowerCase().includes('city')) return "Urban USA";
            
            return "United States";
        }

        function extractCaseType(description) {
            if (description.toLowerCase().includes('diabetes') || description.toLowerCase().includes('food')) {
                return "Ultra-processed Foods";
            }
            if (description.toLowerCase().includes('injury') || description.toLowerCase().includes('accident')) {
                return "Personal Injury";
            }
            if (description.toLowerCase().includes('medical') || description.toLowerCase().includes('malpractice')) {
                return "Medical Malpractice";
            }
            return "Legal Services";
        }

        // New Persona Button
        newPersonaBtn.addEventListener('click', function() {
            chatInterface.style.display = 'none';
            personaCreationInterface.style.display = 'block';
            personaAttributes.value = '';
            selectedPersona = null;
            
            chatContainer.innerHTML = `
                <div class="chat-message persona">
                    <div class="sender">System</div>
                    Describe a persona above to start chatting!
                </div>
            `;
            
            chatInput.disabled = true;
            sendChatBtn.disabled = true;
        });

        // Display poll results
        function displayPollResults(results) {
            pollSummary.innerHTML = `
                <div class="poll-metric">
                    <div class="poll-metric-value">${results.summary.likely}%</div>
                    <div class="poll-metric-label">Likely to Respond</div>
                </div>
                <div class="poll-metric">
                    <div class="poll-metric-value">${results.summary.unlikely}%</div>
                    <div class="poll-metric-label">Unlikely to Respond</div>
                </div>
                <div class="poll-metric">
                    <div class="poll-metric-value">${results.summary.neutral}%</div>
                    <div class="poll-metric-label">Neutral/Unsure</div>
                </div>
                <div class="poll-metric">
                    <div class="poll-metric-value">${results.summary.total_responses}</div>
                    <div class="poll-metric-label">Total Personas</div>
                </div>
            `;
            
            pollDetails.innerHTML = results.responses.map(r => `
                <div class="poll-response">
                    <div class="poll-response-header">${r.persona} (${r.sentiment})</div>
                    <div class="poll-response-text">${r.response}</div>
                </div>
            `).join('');
            
            pollResults.style.display = 'block';
        }

        // Chat Functionality
        async function sendMessage() {
            if (!selectedPersona || !chatInput.value.trim()) return;
            
            const userMessage = chatInput.value.trim();
            
            // Add user message to chat
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'chat-message user';
            userMsgDiv.innerHTML = `
                <div class="sender">You</div>
                ${userMessage}
            `;
            chatContainer.appendChild(userMsgDiv);
            
            chatInput.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message persona';
            loadingDiv.innerHTML = `
                <div class="sender">${selectedPersona.name}</div>
                <span class="loading-spinner"></span> Thinking...
            `;
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                const response = await fetch(window.CONFIG.chatEndpointUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        persona_attributes: personaAttributes.value.trim(),
                        message: userMessage
                    })
                });
                
                const result = await response.json();
                
                // Remove loading message
                chatContainer.removeChild(loadingDiv);
                
                // Add persona response
                const personaResponse = result.persona_response || "I'm having trouble responding right now. Please try again.";
                const responseMsgDiv = document.createElement('div');
                responseMsgDiv.className = 'chat-message persona';
                responseMsgDiv.innerHTML = `
                    <div class="sender">${selectedPersona.name}</div>
                    ${personaResponse}
                `;
                chatContainer.appendChild(responseMsgDiv);
                
            } catch (error) {
                // Remove loading and show error
                chatContainer.removeChild(loadingDiv);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message persona';
                errorDiv.innerHTML = `
                    <div class="sender">System</div>
                    Sorry, I couldn't connect to ${selectedPersona.name} right now. Please check your connection and try again.
                `;
                chatContainer.appendChild(errorDiv);
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Event Listeners
        sendChatBtn.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeImageUploads();
            
            // Set up file upload handlers for data files
            handleFileUpload('mri_file', 'mriFiles');
            handleFileUpload('targetsmart_file', 'targetsmartFiles');
            handleFileUpload('client_file', 'clientFiles');
            
            console.log('Signal Digital Twin Platform loaded');
            console.log('Update CONFIG object with your n8n webhook URLs');
        });
